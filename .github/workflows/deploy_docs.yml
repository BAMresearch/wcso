name: HTML_Docs

on:
  workflow_run:
    workflows: ["CI"]
    types: 
        - completed

  workflow_dispatch:

concurrency:
  group: gh-pages-deploy
  cancel-in-progress: false

jobs:
  build-and-deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1) Checkout
      - name: Checkout main
        uses: actions/checkout@v4

      # 2) Java for Widoco
      - name: Set up Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # 3) Load Widoco
      - name: Download Widoco
        run: |
          wget -O widoco.jar https://github.com/dgarijo/Widoco/releases/download/v1.4.25/widoco-1.4.25-jar-with-dependencies_JDK-11.jar

      # 4) Build Widoco
      - name: Build Widoco
        run: |
          rm -rf public
          mkdir -p public/_widoco

          java -jar widoco.jar \
            -ontFile wcso.owl \
            -outFolder public/_widoco \
            -uniteSections \
            -includeAnnotationProperties \
            -lang en-de \
            -getOntologyMetadata \
            -noPlaceHolderText \
            -rewriteAll \
            -webVowl

          # Deal with deployment of different Widoco versions
          if [ -d "public/_widoco/doc" ]; then
            cp -r public/_widoco/doc/* public/
          else
            cp -r public/_widoco/* public/
          fi

          # Create index.html equal to index-en.html 
          if [ -f "public/index-en.html" ] && [ ! -f "public/index.html" ]; then
            cp public/index-en.html public/index.html
          fi

      # 5) Python for MkDocs
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 6) Install MkDocs + Plugins
      - name: Install MkDocs and plugins
        run: |
          pip install mkdocs mkdocs-d2-plugin

        
      # 7) Install D2 executable (required by mkdocs-d2-plugin)
      - name: Install D2
        shell: bash
        run: |
          curl -fsSL https://d2lang.com/install.sh | sh -s --
          
          # Ensure ~/.local/bin is on PATH for subsequent steps
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          export PATH="$HOME/.local/bin:$PATH"
          d2 version


      # 8) Build MkDocs
      - name: Build MkDocs
        run: |
          mkdocs build --config-file mkdocs.yaml

      # 9) Copy MkDocs-Site to /docs in staging
      - name: Stage MkDocs under /docs
        run: |
          mkdir -p public/docs
          cp -r site/* public/docs/

      # 10) Pages compatibility
      - name: Disable Jekyll and keep CNAME
        run: |
          touch public/.nojekyll
          if [ -f CNAME ]; then cp CNAME public/CNAME; fi

      # 11) Deploy of combined content (Widoco doc to gh-pages root; Mkdocs to /docs/ folder)
      - name: Deploy to gh-pages (single atomic push)
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: gh-pages
          build_dir: public
          keep_history: true
        env:
         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}